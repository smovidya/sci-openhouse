import { useSetAtom } from 'jotai';
import { myMajor, page } from '../app';
import { FC, useState} from 'react';
import {
	techQuestion as techQ,
	techExtra as techExtra,
	techSuperUltraSpecial as techSuperUltraSpecial,
} from '../components/ui/elements/questions';
// import { Button } from '../components/ui/button';

type SaiProps = {
	sai: number;
};

const Tech: FC<SaiProps> = ({ sai }) => {
	const [currentQuestion, setCurrentQuestion] = useState(0);
	const [selectedOption, setSelectedOption] = useState(-1);
	const [isFinished, setIsFinished] = useState(false);
	const [isFinished2, setIsFinished2] = useState(false);
	const [ , setAnswers] = useState<number[]>(Array(6).fill(-1));

	const setPage = useSetAtom(page);
	const setMyMajor = useSetAtom(myMajor);

	// Navigate to the next question
	const handleNext = (option: number) => {
		setAnswers((prevAnswers) => {
			const newAnswers = [...prevAnswers];
			newAnswers[currentQuestion] = option;
			setSelectedOption(-1);

			if (currentQuestion < techQ.length - 1) {
				setCurrentQuestion(currentQuestion + 1);
			} else if (determineHighestSai(newAnswers).length === 1) {
				handleResult(determineHighestSai(newAnswers)[0]);
			} else {
				console.log('extra 1');
				setCurrentQuestion(0);
				setIsFinished(true);
			}
			return newAnswers;
		});
	};
	const handleNextExtra1 = (option: number) => {
		setAnswers((prevAnswers) => {
			const newAnswers = [...prevAnswers];
			newAnswers[currentQuestion + 3] = option;
			setSelectedOption(-1);
			console.log('extra1 ' + newAnswers);

			if (currentQuestion < techExtra.length - 1) {
				setCurrentQuestion(currentQuestion + 1);
			} else if (determineHighestSai(newAnswers).length === 1) {
				handleResult(determineHighestSai(newAnswers)[0]);
			} else {
				console.log('extra 2');
				setCurrentQuestion(0);
				setIsFinished2(true);
			}
			return newAnswers;
		});
	};
	const handleNextExtra2 = (option: number) => {
		setAnswers((prevAnswers) => {
			const newAnswers = [...prevAnswers];
			newAnswers[currentQuestion + 5] = option;
			setSelectedOption(-1);
			handleResult(determineHighestSai(newAnswers)[0]);
			return newAnswers;
		});
	};

	// Navigate to the previous question
	// const handlePrevious = () => {
	// 	if (currentQuestion > 0) {
	// 		const previousAnswer = answers[currentQuestion - 1];
	// 		setSelectedOption(previousAnswer);
	// 		setCurrentQuestion(currentQuestion - 1);
	// 	}
	// };

	// Determine the most frequent "sai" or handle tie cases
	const determineHighestSai = (answers: number[]) => {
		const freqMap: Record<number, number> = {};
		answers.forEach((num) => {
			if (num !== -1) {
				freqMap[num] = (freqMap[num] || 0) + 1;
			}
		});

		const maxFreq = Math.max(...Object.values(freqMap));
		const mostFrequent = Object.keys(freqMap)
			.filter((key) => freqMap[Number(key)] === maxFreq)
			.map(Number);

		console.log('Most frequent majors:', mostFrequent);

		return mostFrequent;
	};

	// Set the result and navigate to the result page
	const handleResult = (index: number) => {
		if (sai === 0) {
			switch (index) {
				case 0:
					setMyMajor(1);
					break;
				case 1:
					setMyMajor(2);
					break;
				case 2:
					setMyMajor(3);
					break;
				case 3:
					setMyMajor(4);
					break;
				default:
					setMyMajor(-1);
					break;
			}
		} else if (sai === 1) {
			switch (index) {
				case 0:
					setMyMajor(5);
					break;
				case 1:
					setMyMajor(6);
					break;
				case 2:
					setMyMajor(7);
					break;
				case 3:
					setMyMajor(8);
					break;
				default:
					setMyMajor(-1);
					break;
			}
		} else if (sai === 2) {
			switch (index) {
				case 0:
					setMyMajor(9);
					break;
				case 1:
					setMyMajor(10);
					break;
				case 2:
					setMyMajor(11);
					break;
				default:
					setMyMajor(-1);
					break;
			}
		} else if (sai === 3) {
			switch (index) {
				case 0:
					setMyMajor(12);
					break;
				case 1:
					setMyMajor(13);
					break;
				case 2:
					setMyMajor(14);
					break;
				case 3:
					setMyMajor(15);
					break;
				case 4:
					setMyMajor(16);
					break;
				case 5:
					setMyMajor(17);
					break;
				default:
					setMyMajor(-1);
					break;
			}
		}

		console.log('major :' + index);
		setPage('result');
	};

	return (
		<div>
			{!isFinished && (
				<div className="bg-question flex flex-col pt-32">
					<div className="text-6xl font-SilverStone-Regular text-Yellow my-4 text-center">
						QUESTION {techQ[currentQuestion].id}
					</div>
					<div className="text-lg mb-6 text-Yellow font-ibm-plex-thai text-center">
						{techQ[currentQuestion].question}
					</div>
					<div className="space-y-4 mb-4">
						{techQ[currentQuestion].choices.map((choice, index) => (
							<button
								key={index}
								onClick={() => handleNext(index)}
								className={`w-full p-3 rounded-md font-ibm-plex-thai ${
									selectedOption === index
										? 'bg-gray-400 text-white'
										: 'bg-gray-200'
								}`}
							>
								{choice}
							</button>
						))}
					</div>
					{/* <Button
						onClick={handlePrevious}
						className="w-20 text-Yellow border border-Yellow rounded-md bg-Yellow bg-opacity-25 disabled:bg-Yellow-400 font-ibm-plex-thai"
						disabled={currentQuestion === 0}
					>
						Back
					</Button> */}
				</div>
			)}
			{isFinished && !isFinished2 && (
				<div className="bg-question flex flex-col pt-32">
					<div className="text-6xl font-SilverStone-Regular text-Yellow my-4 text-center">
						QUESTION {techExtra[currentQuestion].id}
					</div>
					<div className="text-lg mb-6 text-Yellow font-ibm-plex-thai text-center">
						{techExtra[currentQuestion].question}
					</div>
					<div className="space-y-4 mb-4">
						{techExtra[currentQuestion].choices.map((choice, index) => (
							<button
								key={index}
								onClick={() => {
									handleNextExtra1(index);
								}}
								className={`w-full p-3 rounded-md font-ibm-plex-thai ${
									selectedOption === index
										? 'bg-gray-400 text-white'
										: 'bg-gray-200'
								}`}
							>
								{choice}
							</button>
						))}
					</div>
					{/* <Button
						onClick={handlePrevious}
						className="w-20 text-Yellow border border-Yellow rounded-md bg-Yellow bg-opacity-25 disabled:bg-Yellow-400 font-ibm-plex-thai"
						disabled={currentQuestion === 0}
					>
						Back
					</Button> */}
				</div>
			)}
			{isFinished && isFinished2 && (
				<div className="bg-question flex flex-col pt-32">
					<div className="text-6xl font-SilverStone-Regular text-Yellow my-4 text-center">
						EXTRA QUESTION
					</div>
					<div className="text-lg mb-6 text-Yellow font-ibm-plex-thai text-center">
						{techSuperUltraSpecial[currentQuestion].question}
					</div>
					<div className="space-y-4 mb-4">
						{techSuperUltraSpecial[currentQuestion].choices.map(
							(choice, index) => (
								<button
									key={index}
									onClick={() => {
										handleNextExtra2(index);
									}}
									className={`w-full p-3 rounded-md font-ibm-plex-thai ${
										selectedOption === index
											? 'bg-gray-400 text-white'
											: 'bg-gray-200'
									}`}
								>
									{choice}
								</button>
							)
						)}
					</div>
					{/* <Button
						onClick={handlePrevious}
						className="w-20 text-Yellow border border-Yellow rounded-md bg-Yellow bg-opacity-25 disabled:bg-Yellow-400 font-ibm-plex-thai"
						disabled={currentQuestion === 0}
					>
						Back
					</Button> */}
				</div>
			)}
		</div>
	);
};

export { Tech };
